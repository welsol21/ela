#:kivy 2.2.0

# ─────────────────────────────────────────────────────────
# Reusable full-width Back button (top line on every screen)
# ─────────────────────────────────────────────────────────
<BackBar@Button>:
    size_hint_y: None
    height: 36
    text: "Back"
    on_release: app.go_back()

# ─────────────────────────────────────────────────────────
# Flat vocabulary row for export table (checkbox | Project | File | Items | Created)
# ─────────────────────────────────────────────────────────
<VocabFlatRow@BoxLayout>:
    node_id: ""
    project: ""
    file: ""
    count: 0
    created: ""
    checked: False
    size_hint_y: None
    height: 34
    canvas.before:
        Color:
            rgba: 0.12,0.12,0.12,1
        Rectangle:
            pos: self.pos
            size: self.size
    BoxLayout:
        orientation: "horizontal"
        size_hint_y: None
        height: 34
        spacing: 0

        # checkbox (row)
        BoxLayout:
            size_hint_x: None
            width: 40
            canvas.before:
                Color:
                    rgba: 0.35,0.35,0.35,1
                Line:
                    rectangle: (self.x, self.y, self.width, self.height)
            CheckBox:
                id: cb
                size_hint: None, None
                size: 22, 22
                pos_hint: {"center_y": .5}
                active: root.checked

        # Project
        Label:
            text: root.project
            size_hint_x: None
            width: 220
            halign: "left"
            valign: "middle"
            text_size: self.size
            shorten: True
            shorten_from: "right"
            canvas.before:
                Color:
                    rgba: 0.35,0.35,0.35,1
                Line:
                    rectangle: (self.x, self.y, self.width, self.height)

        # File (flex)
        Label:
            text: root.file
            size_hint_x: 1
            halign: "left"
            valign: "middle"
            text_size: self.size
            shorten: True
            shorten_from: "right"
            canvas.before:
                Color:
                    rgba: 0.35,0.35,0.35,1
                Line:
                    rectangle: (self.x, self.y, self.width, self.height)

        # Items
        Label:
            text: str(root.count)
            size_hint_x: None
            width: 90
            halign: "right"
            valign: "middle"
            text_size: self.size
            canvas.before:
                Color:
                    rgba: 0.35,0.35,0.35,1
                Line:
                    rectangle: (self.x, self.y, self.width, self.height)

        # Created
        Label:
            text: root.created
            size_hint_x: None
            width: 130
            halign: "right"
            valign: "middle"
            text_size: self.size
            canvas.before:
                Color:
                    rgba: 0.35,0.35,0.35,1
                Line:
                    rectangle: (self.x, self.y, self.width, self.height)

# ─────────────────────────────────────────────────────────
# PROJECTS LIST
# ─────────────────────────────────────────────────────────
<Projects>:
    BoxLayout:
        orientation: "vertical"
        spacing: 10

        # Title (left) + actions (right)
        BoxLayout:
            size_hint_y: None
            height: 44
            Label:
                text: "Projects"
                color: 1,1,0,1
                font_size: "24sp"
                halign: "left"
                valign: "middle"
                text_size: self.size
            BoxLayout:
                size_hint_x: None
                width: 180
                spacing: 8
                Button:
                    text: "New Project"
                    on_release: app.go("new_project")

        Table:
            id: tbl
            headers: ["Name", "Created", "Updated", "Analyzed"]

# ─────────────────────────────────────────────────────────
# PROJECT FILES
# ─────────────────────────────────────────────────────────
<Files>:
    # expects: .project_name set from python
    BoxLayout:
        orientation: "vertical"
        spacing: 10

        BoxLayout:
            size_hint_y: None
            height: 44
            Label:
                id: project_label
                text: root.project_name if hasattr(root, "project_name") else ""
                color: 1,1,0,1
                font_size: "20sp"
                halign: "left"
                valign: "middle"
                text_size: self.size
            BoxLayout:
                size_hint_x: None
                width: 160
                spacing: 8
                Button:
                    text: "New File"
                    on_release: app.open_new_file_screen()

        Table:
            id: tbl
            headers: ["Name", "Settings", "Updated", "Analyzed"]

# ─────────────────────────────────────────────────────────
# NEW PROJECT
# ─────────────────────────────────────────────────────────
<NewProject>:
    BoxLayout:
        orientation: "vertical"
        spacing: 12
        padding: 10

        BoxLayout:
            size_hint_y: None
            height: 44
            Label:
                text: "New Project"
                color: 1,1,0,1
                font_size: "22sp"
                halign: "left"
                valign: "middle"
                text_size: self.size
            BoxLayout:
                size_hint_x: None
                width: 1

        TextInput:
            id: name_input
            hint_text: "Project name"
            multiline: False
            size_hint_y: None
            height: 40
        Button:
            text: "Create"
            size_hint_y: None
            height: 44
            on_release: root.create()

# ─────────────────────────────────────────────────────────
# NEW FILE
# ─────────────────────────────────────────────────────────
<NewFile>:
    BoxLayout:
        orientation: "vertical"
        spacing: 10
        padding: 10

        BoxLayout:
            size_hint_y: None
            height: 44
            Label:
                id: project_label
                text: ""
                color: 1,1,0,1
                font_size: "20sp"
                halign: "left"
                valign: "middle"
                text_size: self.size
            BoxLayout:
                size_hint_x: None
                width: 1

        GridLayout:
            cols: 2
            spacing: 8
            padding: [10, 0]
            size_hint_y: None
            height: self.minimum_height

            Label:
                text: "Translator:"
            Spinner:
                id: translator
                text: "GPT"
                values: ["GPT", "HuggingFace", "DeepL", "Original"]
                size_hint_y: None
                height: 36

            Label:
                text: "Subtitles:"
            Spinner:
                id: subtitles
                text: "Bilingual"
                values: ["English", "Bilingual", "Ru subs"]
                size_hint_y: None
                height: 36

            Label:
                text: "Voice:"
            Spinner:
                id: voice
                text: "Male"
                values: ["Male", "Female"]
                size_hint_y: None
                height: 36

            Label:
                text: "File:"
            Button:
                text: root.selected_path
                size_hint_y: None
                height: 36
                on_release: root.choose_file()

        Label:
            id: status
            markup: True
            size_hint_y: None
            height: 24
        Button:
            text: "Create"
            size_hint_y: None
            height: 44
            on_release: root.create()

# ─────────────────────────────────────────────────────────
# ANALYZE LIST
# ─────────────────────────────────────────────────────────
<AnalyzeList>:
    BoxLayout:
        orientation: "vertical"
        spacing: 10
        padding: 10

        BoxLayout:
            size_hint_y: None
            height: 44
            Label:
                text: "Analyze Files"
                color: 1,1,0,1
                font_size: "24sp"
                halign: "left"
                valign: "middle"
                text_size: self.size
            BoxLayout:
                size_hint_x: None
                width: 1

        Table:
            id: tbl
            headers: ["File", "Project", "Analyzed", "Updated"]

# ─────────────────────────────────────────────────────────
# ANALYZE DETAIL
# ─────────────────────────────────────────────────────────
<AnalyzeDetail>:
    BoxLayout:
        orientation: "vertical"
        spacing: 10
        padding: 10

        BoxLayout:
            size_hint_y: None
            height: 44
            Label:
                id: project_label
                text: ""
                color: 1,1,0,1
                font_size: "20sp"
                halign: "left"
                valign: "middle"
                text_size: self.size
            BoxLayout:
                size_hint_x: None
                width: 1

        Label:
            id: file_label
            text: ""
            color: 1,1,0,1
            font_size: "18sp"
            size_hint_y: None
            height: 26

        GridLayout:
            cols: 2
            spacing: 8
            size_hint_y: None
            height: self.minimum_height

            Label:
                text: "Translator:"
            Spinner:
                id: an_tr
                text: "GPT"
                values: ["GPT", "HuggingFace", "DeepL", "Original"]
                size_hint_y: None
                height: 36

            Label:
                text: "Subtitles:"
            Spinner:
                id: an_sub
                text: "Bilingual"
                values: ["English only", "Bilingual sequential", "Bilingual simultaneous", "English + Russian subs", "Bilingual audio + Russian subs"]
                size_hint_y: None
                height: 36

            Label:
                text: "Voice:"
            Spinner:
                id: an_voice
                text: "Male"
                values: ["Male", "Female"]
                size_hint_y: None
                height: 36

        Label:
            id: status
            text: ""
            markup: True
            color: 1,1,0,1
            font_size: "20sp"
            size_hint_y: None
            height: 30
        Workspace:
            id: ws
            size_hint_y: None
            height: 120
        Button:
            text: "Start pipeline"
            size_hint_y: None
            height: 44
            on_release: root.start()

# ─────────────────────────────────────────────────────────
# VOCABULARY (export on main screen)
# ─────────────────────────────────────────────────────────
<Vocabulary>:
    BoxLayout:
        orientation: "vertical"
        spacing: 10
        padding: 10


        # Title + actions
        BoxLayout:
            size_hint_y: None
            height: 44
            Label:
                text: "Vocabulary"
                color: 1,1,0,1
                font_size: "22sp"
                halign: "left"
                valign: "middle"
                text_size: self.size
            BoxLayout:
                size_hint_x: None
                width: 420
                spacing: 8
                Button:
                    text: "Quiz"
                    on_release: root.open_quiz()
                Button:
                    text: "Export JSON"
                    on_release: root.on_export_json()
                Button:
                    text: "Export CSV"
                    on_release: root.on_export_csv()

        # Table header
        BoxLayout:
            size_hint_y: None
            height: 34
            canvas.before:
                Color:
                    rgba: 0.20,0.20,0.20,1
                Rectangle:
                    pos: self.pos
                    size: self.size
                Color:
                    rgba: 0.35,0.35,0.35,1
                Line:
                    rectangle: (self.x, self.y, self.width, self.height)

            # header checkbox (select all)
            BoxLayout:
                size_hint_x: None
                width: 40
                canvas.before:
                    Color:
                        rgba: 0.35,0.35,0.35,1
                    Line:
                        rectangle: (self.x, self.y, self.width, self.height)
                CheckBox:
                    id: app_cb
                    size_hint: None, None
                    size: 22, 22
                    pos_hint: {"center_y": .5}
                    on_active: root.header_toggle(self.active)

            Label:
                text: "Project"
                size_hint_x: None
                width: 220
                bold: True
                halign: "left"
                valign: "middle"
                text_size: self.size
                canvas.before:
                    Color:
                        rgba: 0.35,0.35,0.35,1
                    Line:
                        rectangle: (self.x, self.y, self.width, self.height)

            Label:
                text: "File"
                bold: True
                halign: "left"
                valign: "middle"
                text_size: self.size
                canvas.before:
                    Color:
                        rgba: 0.35,0.35,0.35,1
                    Line:
                        rectangle: (self.x, self.y, self.width, self.height)

            Label:
                text: "Items"
                size_hint_x: None
                width: 90
                bold: True
                halign: "right"
                valign: "middle"
                text_size: self.size
                canvas.before:
                    Color:
                        rgba: 0.35,0.35,0.35,1
                    Line:
                        rectangle: (self.x, self.y, self.width, self.height)

            Label:
                text: "Created"
                size_hint_x: None
                width: 130
                bold: True
                halign: "right"
                valign: "middle"
                text_size: self.size
                canvas.before:
                    Color:
                        rgba: 0.35,0.35,0.35,1
                    Line:
                        rectangle: (self.x, self.y, self.width, self.height)

        # Table body
        ScrollView:
            do_scroll_x: False
            GridLayout:
                id: vocab_rows
                cols: 1
                size_hint_y: None
                height: self.minimum_height
                spacing: 0
