# English Language Assistant — UI README

## Обзор

Прототип реализован на **Kivy 2.2.x** и состоит из набора экранов (`ScreenManager`). Во всех окнах единый макет:

- **Верхняя полоса** — одна широкая кнопка `Back` (создаётся в Python, а не в KV).
- **Вторая строка** — заголовок слева и действия справа.
- **Далее** — контент экрана (таблицы, формы, списки).

Состояние приложения хранится в упрощённом «ин-мемори» слое DB (проекты, файлы и текущий выбранный проект `DB.cur_proj`).

---

## Точки входа и версии

- **Запуск:**  
    ```bash
    python main_menu_app.py
    ```
- **Требуемая версия Kivy:** 2.2.x  
    В KV-файле используется директива `#:kivy 2.2.0`. Если у вас Kivy 2.3+, можно поднять версию директивы, но текущая сборка ориентирована на 2.2.x.

---

## Структура файлов

- `main_menu_app.py` — логика экранов, навигация, слой DB, экспорт, таблицы.
- `main_menu.kv` — разметка экранов, таблиц и модалок (без верхней кнопки Back — она создаётся кодом).

---

## Навигация

Навигация вынесена в методы приложения:

- `app.go(screen_name)` — переход на экран с запоминанием стека.
- `app.go_back()` — возврат на предыдущий экран; если стек пуст — на «Projects».

Единая верхняя кнопка `Back` управляется из Python (создаётся один раз, текст можно менять маппингом по экрану).

---

## Данные (внутренняя модель)

- `DB.projects` — список проектов. Каждый проект содержит:

    ```python
    {
        "name": str,
        "created": str,   # например, "Sep 27, 2025"
        "updated": str,
        "files": [
            {
                "name": str,
                "translator": "GPT" | "HuggingFace" | "DeepL" | "Original",
                "subtitles": "English" | "Bilingual" | ...,
                "voice": "Male" | "Female",
                "path": str,
                "analyzed": bool,
                "lex_items": int,     # количество лексем для Vocabulary
                "created": str,
                "updated": str
            },
            ...
        ]
    }
    ```

- `DB.cur_proj` — текущий выбранный проект (`dict`), обновляется при клике по проекту в таблице.

- Для экспорта словарей используется формат идентификаторов `file:<pi>:<fi>` (индексы проекта и файла).  
    Это важно: именно такой формат ожидает функция `DB.collect_entries(ids)`.

---

## Компоненты таблиц

Кастомный виджет `Table` (в Python) поддерживает добавление строк с кликом:

```python
tbl.add_row(["col1", "col2", ...], press=callback)
```

- Строка — это кнопка (наследует `ButtonBehavior`), поэтому клик доступен по всей строке.
- Для каждой таблицы явно передаётся `press=...` на обработчик.
- В Vocabulary используется отдельный строковый виджет `VocabFlatRow` (в KV):  
    чекбокс | Project | File | Items | Created.

---

## Экраны

### 1. Projects

- **Цель:** список проектов и переход к файлам проекта.
- **Заголовок:** Projects. Справа действие: New Project.
- **Таблица:** Name | Created | Updated | Analyzed  
    В Analyzed показывается «кол-во обработанных файлов / всего».
- **Клик по строке:**  
    - Ставит `DB.cur_proj = proj`
    - Переходит на экран Files

---

### 2. New Project

- **Цель:** быстрый ввод и создание проекта.
- **Заголовок:** New Project. (Кнопок справа нет.)
- **Поля:** поле ввода имени и кнопка Create.
- **Действие:** по нажатию — валидируется и добавляется запись в `DB.projects`, возврат на Projects.

---

### 3. Files (экран проекта)

- **Цель:** список файлов выбранного проекта.
- **Заголовок:** имя проекта. Справа действие: New File.
- **Таблица:** Name | Settings | Updated | Analyzed.
- **New File:** переход на экран New File (используется `DB.cur_proj`).

---

### 4. New File

- **Цель:** добавить новый файл в текущий проект.
- **Заголовок:** New file → `<ProjectName>` (выводится по `DB.cur_proj["name"]`).
- **Поля:** Translator / Subtitles / Voice / File (кнопка выбора).
- **Кнопка Create:** добавляет файл в `DB.cur_proj["files"]` с дефолтами:
    - `analyzed = False`
    - `lex_items = 0`
    - `created/updated` — по текущей дате
- **Возврат на Files.**

---

### 5. Analyze Files (AnalyzeList)

- **Цель:** обзор файлов для обработки.
- **Заголовок:** Analyze Files.
- **Таблица:** File | Project | Analyzed | Updated.
- **Клик по строке:** переход на Analyze Detail выбранного файла/проекта.

---

### 6. Analyze Detail

- **Цель:** настройки пайплайна анализа для конкретного файла.
- **Заголовок:** имя проекта; строкой ниже — имя файла.
- **Настройки (Spinner):** Translator, Subtitles, Voice.
- **Статус (Label)** и **рабочая область (Workspace)**.
- **Кнопка Start pipeline** — сейчас заглушка (готова для интеграции).

---

### 7. Vocabulary (экспорт без модалок)

- **Цель:** просмотр и экспорт лексики по только обработанным файлам.
- **Заголовок:** Vocabulary. Справа действия: Quiz, Export JSON, Export CSV.
- **Шапка таблицы:** чекбокс слева — это «Select all».
- **Тело:** плоский список строк (без уровней): чекбокс | Project | File | Items | Created.
- В таблицу попадают только файлы с `analyzed=True`.
- Значение Items берётся из `lex_items`.

#### Export JSON / Export CSV

- Собираются выделенные `node_id` формата `file:<pi>:<fi>`.
- `Vocabulary._make_payload(ids, fmt)` → json/csv-строка.
- `Vocabulary._save_dialog(text, ext)` показывает результат (прототип).

#### Quiz

- Открывает модалку `QuizModal` с настройками: режим (Multiple choice / Flashcards) и количество вопросов.
- Кнопка Start — точка входа для подключения реального квиза.

---

## Важные детали реализации

### Формат идентификаторов для экспорта

Чтобы экспорт возвращал корректные записи, `node_id` у строк Vocabulary должен быть именно `file:<pi>:<fi>`.  
В коде `Vocabulary._build_flat_table()` это уже так делается.

### Где берутся «Items»

Из `file["lex_items"]`. Если это поле не заполнено, в UI будет 0.  
При интеграции пайплайна анализа — обновляйте `lex_items` и `analyzed=True`.

### Верхняя кнопка Back

Создаётся в Python один раз и не дублируется в KV.  
Она управляет стеком экранов (`go` / `go_back`). При желании можно менять её текст в зависимости от текущего экрана (маппингом).

### Кликабельность строк таблиц

Обязательно передавайте `press=...` в `tbl.add_row(...)`:

```python
tbl.add_row(["Name", ...], press=partial(self.select, obj))
```

Иначе строка останется «немой».

---

## Как запустить

1. Установите зависимости (пример):

     ```bash
     pip install kivy==2.2.1
     ```

2. Запустите:

     ```bash
     python main_menu_app.py
     ```

3. Проверьте:

     - Переход Projects → Files (клик по строке).
     - New Project / New File добавляют записи.
     - Analyze Files/Detail открываются.
     - Vocabulary показывает только analyzed-файлы и экспортирует выделенные.
